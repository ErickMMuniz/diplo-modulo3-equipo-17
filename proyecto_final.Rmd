---
title: "Proyecto final módulo 3"
author: "Equipo - n"
output: html_document
---

# Integrantes:

+ Integrante 1. Rol: Administrador
+ Integrante 2. Rol: Colaborador 1
+ Integrante 3. Rol: Colaborador 2

```{r}
library(DBI)
library(dplyr)
library(RSQLite)
library(lubridate)
library(ggplot2)

conn <- DBI::dbConnect(RSQLite::SQLite(), "baseball.db")
```


```{r}
bateo <- dbGetQuery(conn, "SELECT * FROM bateo") 
escuelas <- dbGetQuery(conn, "SELECT * FROM escuelas")
escuelasJugadores <- dbGetQuery(conn, "SELECT * FROM escuelasJugadores")
field <- dbGetQuery(conn, "SELECT * FROM field")
nombres <- dbGetQuery(conn, "SELECT * FROM nombres")
pitcheo <- dbGetQuery(conn, "SELECT * FROM pitcheo")
salarios <- dbGetQuery(conn, "SELECT * FROM salarios")
salonFama <- dbGetQuery(conn, "SELECT * FROM salonFama")
``` 

```{r}
dbListTables(conn)
```


#Segunda parte

Deberá realizar un EDA detallado que incluya tablas y gráficas que al menos respondan las siguientes preguntas:

1 - ¿Cuál es la duración promedio de la carrera de un jugador de béisbol profesional según su posición?

Suponiendo que la tabla `nombres` contiene a los jugadores y `field` contiene 
las posiciones según la llave `playerID`, hacemos una intersección de estas dos tablas. 


```{r}
dbGetQuery(conn, "SELECT DISTINCT n.playerID, f.POS, n.debut, n.finalGame  FROM field AS f LEFT JOIN nombres as n on n.playerID = f.playerID") |>
  dplyr::mutate(tiempo_jugado = lubridate::ymd(finalGame) - lubridate::ymd(debut)) |>
  dplyr::group_by(POS) |>
  dplyr::summarise(dias = mean(tiempo_jugado,na.rm = TRUE) ) |>
  dplyr::arrange(desc(dias))
``` 

2 - ¿Cómo se comparan los promedios de bateo entre jugadores que asistieron a la universidad y los que no?


Dado que la tabla `escuelas` no tiene indica si es universidad, vamos a suponer que 
aquellos jugadores que no aparecen en `escuelasjugadores` significa que no asistieron
a la universidad. 

Definimos el promedio de bateo por jugador es H / AB (hits entre el número de 
oportunidades de bateo). 

```{r}
dbGetQuery(conn, 
   "SELECT DISTINCT a.playerID, (CASE WHEN schoolID IS NOT NULL THEN 1 ELSE 0 END) si_estudio , a.AB, a.H FROM bateo AS a LEFT JOIN escuelasjugadores AS b ON a.playerID = b.playerID") |>
  dplyr::group_by(si_estudio) |>
  dplyr::summarise(promedio_bateo = sum(H) / sum(AB),) |>
  head()
```
```{r}
dbGetQuery(conn, 
   "SELECT DISTINCT a.playerID, (CASE WHEN schoolID IS NOT NULL THEN 1 ELSE 0 END) si_estudio , a.AB, a.H FROM bateo AS a LEFT JOIN escuelasjugadores AS b ON a.playerID = b.playerID") |>
  dplyr::group_by(playerID) |>
  dplyr::summarise(promedio_bateo = sum(H) / sum(AB), 
                   si_estudio = si_estudio) |>
  ggplot2::ggplot(aes(x = promedio_bateo , fill = factor(si_estudio)) ) +
  ggplot2::geom_density()
```

Dado que las gráficas y la media entre los jugadores según su escolaridad, no hay 
una diferencia significativa. 


3 - ¿Los jugadores con carreras más largas tienden a tener salarios más altos?

Por practicidad, dado que los jugadores cambiaban de salario por año, vamos a 
ponderar su salario con la media. 



```{r}
numero_completo <- function(x) format(x, big.mark = ",", scientific = FALSE)
dbGetQuery(conn, "SELECT DISTINCT n.playerID, s.salary , n.debut, n.finalGame  
           FROM field AS f LEFT JOIN nombres as n on n.playerID = f.playerID
           LEFT JOIN salarios as s ON n.playerID =  s.playerID WHERE f.yearID = s.yearID") |>
  dplyr::mutate(carrera = lubridate::ymd(finalGame) - lubridate::ymd(debut)) |>
  dplyr::group_by(playerID) |>
  dplyr::summarise(salario_promedio = mean(salary), 
                   carrera = mean(carrera)) |>
  ggplot2::ggplot(aes(x = carrera , y = salario_promedio) ) +
  ggplot2::geom_point() + 
  ggplot2::geom_smooth(method = "lm")
  
```


4 - ¿Existe una diferencia significativa en el rendimiento entre jugadores de diferentes conferencias universitarias?

Rendimiento? 

Bateo
```{r}
dbGetQuery(conn, 
   "SELECT playerID, H numerador, AB denominador, 'Bateo' Posicion FROM bateo 
   UNION ALL
   SELECT playerID, W numerador, W+L denominador, 'Pitcheo' Posicion FROM pitcheo
   UNION ALL
   SELECT playerID, PO + A numerador, PO + A + ifnull(E,0) denominador, 'Fildeo' Posicion FROM field") |>
  dplyr::group_by(Posicion) %>% 
  dplyr::summarise(rendimiento = sum(numerador) / sum(denominador)) %>% 
  ggplot() +
  geom_bar(aes(y = Posicion, x = rendimiento), stat = "identity", fill="#9BCD9B")
```


5. ¿Cómo se relaciona la altura y el peso del jugador con su rendimiento en bateo?

```{r}
dbGetQuery(conn, "SELECT b.playerID, ifnull(b.H,0) H, ifnull(b.AB,0) AB, n.weight, n.height FROM bateo AS b LEFT JOIN nombres as n on n.playerID = b.playerID") %>% 
  dplyr::group_by(playerID) %>% 
  dplyr::summarise(rendimiento = sum(H)/sum(AB),
                   peso = mean(weight),
                   altura = mean(height)) %>% 
  ggplot2::ggplot(aes(x = peso , y = rendimiento) ) +
  ggplot2::geom_point()
```

```{r}
dbGetQuery(conn, "SELECT b.playerID, ifnull(b.H,0) H, ifnull(b.AB,0) AB, n.weight, n.height FROM bateo AS b LEFT JOIN nombres as n on n.playerID = b.playerID") %>% 
  dplyr::group_by(playerID) %>% 
  dplyr::summarise(rendimiento = sum(H)/sum(AB),
                   peso = mean(weight),
                   altura = mean(height)) %>%
  ggplot2::ggplot(aes(x = altura , y = rendimiento) ) +
  ggplot2::geom_point()
```

6. ¿Existe alguna tendencia de los salarios en la MLB en los últimos 50 años?

El salario más antiguo registrado data de 1985, por lo tanto solo se puede hacer el seguimiento de los últimos 31 años.

```{r}
dbGetQuery(conn, 
           "SELECT yearID, salary salario
           FROM salarios") %>% 
  dplyr::group_by(yearID) %>% 
  dplyr::summarise(sueldo = mean(salario)) %>% 
  ggplot(aes(x = yearID, y = sueldo)) +
  geom_line() +
  geom_smooth(method = 'lm')
```


7. ¿Existen disparidades salariales entre jugadores con diferentes antecedentes educativos?

```{r}
dbGetQuery(conn, 
           "SELECT playerID, 
           CASE WHEN playerID IN (SELECT DISTINCT playerID FROM escuelasJugadores
           WHERE schoolID IS NOT NULL) THEN 1 
           ELSE 0 END estudios,
           SUM(salary) salario
           FROM salarios
           GROUP BY 1,2
           ORDER BY 1") %>% 
  dplyr::group_by(estudios) %>% 
  dplyr::summarise(avg = mean(salario),
                   saldo = sum(salario),
                   max = max(salario),
                   min = min(salario))
```


8. ¿La asistencia a la universidad influye en el salario del primer año de un jugador?

```{r}
dbGetQuery(conn, 
           "SELECT B.playerID, A.salary salario, A.yearID,
           CASE WHEN B.playerID IN (SELECT DISTINCT playerID FROM escuelasJugadores) THEN 1 
           ELSE 0 END estudios
           FROM salarios A
           RIGHT JOIN (SELECT playerID, MIN(yearID) year_min
           FROM salarios GROUP BY 1) B
           ON A.playerID = B.playerID AND A.yearID = B.year_min
           ORDER BY B.playerID") %>% 
  dplyr::group_by(estudios) %>% 
  dplyr::summarise(avg = mean(salario),
                   saldo = sum(salario),
                   max = max(salario),
                   min = min(salario))
```

```{r}
salarios1 <- 
  dbGetQuery(conn, 
           "SELECT playerID, salary, yearID,
           CASE WHEN playerID IN (SELECT DISTINCT playerID FROM escuelasJugadores
           WHERE schoolID IS NOT NULL) THEN 1 
           ELSE 0 END estudios
           FROM salarios") %>% 
  dplyr::mutate(year_debut = yearID)

nombres %>% dplyr::mutate(year_debut = year(ymd(debut))) %>% 
  select(year_debut, playerID) %>% 
  dplyr::left_join(salarios1, by = 'playerID') %>% 
  filter(year_debut.x == year_debut.y) %>% 
  select(yearID, playerID, salary, estudios) %>% 
  group_by(estudios) %>% 
  dplyr::summarise(avg = mean(salary),
                   saldo = sum(salary),
                   max = max(salary),
                   min = min(salary))
```



9. ¿Hay alguna relación entre las estadísticas de rendimiento (promedio de bateo, home runs) y el salario?

Si tu AB (número de bateos) es 0, significa que nunca se batio, por lo tanto no puedes 
hacer homeruns ni hits, entonces no se te tomara encuenta.

```{r}
dbGetQuery(conn, 
           "SELECT B.playerID, SUM(B.H) H, SUM(B.AB) AB,
           SUM(B.HR) HR, SUM(ifnull(S.salary,0)) salario
           FROM bateo B
           LEFT JOIN salarios S
           ON B.playerID = S.playerID AND B.yearID = S.yearID
           GROUP BY 1") %>%
  dplyr::mutate(promedio_bateo = H/AB,
                promedio_hr = HR/AB) %>% 
  dplyr::filter(AB != 0) %>% 
  dplyr::summarise(cor_bateo = cor(salario,promedio_bateo),
                   cor_homerun = cor(salario,promedio_hr))
  
```

10. ¿Los lanzadores ganan salarios significativamente diferentes a los bateadores?

Los lanzadores ganan 2.5 millones de dolares menos (en promedio) que los bateadores.

```{r}
dbGetQuery(conn, 
           "WITH BASE AS (SELECT playerID, 
           CASE WHEN playerID IN (SELECT playerID FROM bateo
           WHERE AB != 0) 
           THEN 1 ELSE 0 END BAT,
           CASE WHEN playerID IN (SELECT playerID FROM field
           WHERE POS = 'P')
           THEN 1 ELSE 0 END GUANTE, SUM(salary) salario 
           FROM salarios
           GROUP BY 1,2,3)
           SELECT playerID, CASE WHEN BAT = 1 THEN 'B' 
           ELSE 'L' END POS, salario
           FROM (SELECT playerID,
           CASE WHEN GUANTE = 1 THEN 0 ELSE BAT END BAT,
           GUANTE, salario
           FROM BASE)") %>% 
  dplyr::group_by(POS) %>% 
  dplyr::summarise(avg = mean(salario),
                   saldo = sum(salario),
                   max = max(salario),
                   min = min(salario))
```

11. ¿Qué factores contribuyen a la inducción al Salón de la Fama?



12. ¿Existe una diferencia significativa en las tasas de entrada al Salón de la Fama entre lanzadores y bateadores?

```{r}
dbGetQuery(conn, 
           "WITH BASE AS (SELECT playerID, 
           CASE WHEN playerID IN (SELECT DISTINCT playerID FROM bateo
           WHERE AB != 0) 
           THEN 1 ELSE 0 END BAT,
           CASE WHEN playerID IN (SELECT DISTINCT playerID FROM field
           WHERE POS = 'P')
           THEN 1 ELSE 0 END GUANTE, SUM(salary) salario 
           FROM salarios
           GROUP BY 1,2,3)
           SELECT playerID, CASE WHEN BAT = 1 THEN 'B' 
           ELSE 'L' END POS, salario,
           CASE WHEN playerID IN (SELECT DISTINCT playerID FROM salonFama
           WHERE inducted = 'Y') THEN 1 ELSE 0 END SF
           FROM (SELECT playerID,
           CASE WHEN GUANTE = 1 THEN 0 ELSE BAT END BAT,
           GUANTE, salario
           FROM BASE)") %>% 
  dplyr::group_by(POS) %>% 
  dplyr::summarise(popo = sum(SF)/n())
```


13. ¿El número de homeruns aumenta las probabilidades de ingresar al Salón de la Fama?

```{r}
dbGetQuery(conn, 
           "SELECT playerID, SUM(HR) HR,
           CASE WHEN playerID IN 
           (SELECT DISTINCT playerID 
           FROM salonFama
           WHERE inducted = 'Y')
           THEN 1 ELSE 0 END SF
           FROM bateo
           GROUP BY 1,3") %>% 
  dplyr::summarise(COR_HRXSF = cor(HR,SF))
```


14. ¿Los jugadores de ciertas décadas tienen más probabilidades de ser incluidos al Salón de la Fama?


```{r}
sf1 <- 
  dbGetQuery(conn, 
           "SELECT *
           FROM salonFama
           WHERE inducted = 'Y'
           AND category = 'Player'") 

nombres %>% dplyr::mutate(year_debut = year(ymd(debut)),
                          decada = year_debut - year_debut %%10) %>% 
  select(year_debut, decada, playerID) %>% 
  dplyr::left_join(sf1, by = 'playerID') %>% 
  filter(!is.na(inducted) & !is.na(year_debut)) %>% 
  select(year_debut, decada, playerID) %>%
  group_by(decada) %>% 
  dplyr::summarise(n = n()) %>% 
  arrange(desc(n))
```


15. ¿Qué se puede decir del tiempo en el que un jugador empieza su carrera hasta que se vuelve miembro del Salón de la Fama?

```{r}

```


16. ¿Cómo se relaciona el rendimiento en su primera temporada con la duración de su carrera?

17. ¿Las estadísticas de fielding se relacionan con la duración total de la carrera?

18. ¿Cuál es la probabilidad de que un jugador llegue a las Grandes Ligas según sus estadísticas universitarias?

19. ¿Existen grupos de jugadores con trayectorias profesionales similares según métricas de rendimiento?

20. ¿Cómo afecta el rendimiento de un jugador en sus mejores años a sus ganancias totales en la carrera?